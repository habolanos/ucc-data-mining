SELECT CAPROD.IDCICLO CICLO,
       FAPER.IDPERIODO PERIODO,
       LECONS.CONSUMO CONSUMO_ACTUAL,
       LECONS.CONSUPROME CONSUMO_PROMEDIO,
       LECONS.CONSU1 CONSUMO_MES_1,
       LECONS.CONSU2 CONSUMO_MES_2,
       LECONS.CONSU3 CONSUMO_MES_3,
       LECONS.CONSU4 CONSUMO_MES_4,
       LECONS.CONSU5 CONSUMO_MES_5,
       LECONS.CONSU6 CONSUMO_MES_6,
       LECONS.LECT_ACTUAL LECTURA_ACTUAL,
       LECONS.LECT_ANTERIOR LECTURA_ANTERIOR,
       ARQU.PKG_MDMEPUNTOMEDI.FVAGETIDEQUIPO(CAPRODUC.IDPUNTOMEDI) EQUIPO,
       ARQU.PKG_MDLECOBSERVALECTU.FVAGETNOMBRE(LECONS.IDOBSERVACION) OBSERVACION_LECTURA,
       ARQU.PKG_MDCAESTATECNI.FVAGETDESCESTATECNI(CAPROD.IDESTATECNI) ESTADO_TECNICO,
       ARQU.PKG_MDCARESPOSERVI.FVAGETNOMBRERESPSERV(ARQU.PKG_MDCACONTRATO.FNUGETIDRESPONSABLE(CAPROD.IDCONTRATO)) || ' ' ||
       ARQU.PKG_MDCARESPOSERVI.FVAGETSEGUNDONOMBRE(ARQU.PKG_MDCACONTRATO.FNUGETIDRESPONSABLE(CAPROD.IDCONTRATO)) || ' ' ||
       ARQU.PKG_MDCARESPOSERVI.FVAGETPRIMERAPELLIDO(ARQU.PKG_MDCACONTRATO.FNUGETIDRESPONSABLE(CAPROD.IDCONTRATO)) || ' ' ||
       ARQU.PKG_MDCARESPOSERVI.FVAGETSEGUNDOAPELLIDO(ARQU.PKG_MDCACONTRATO.FNUGETIDRESPONSABLE(CAPROD.IDCONTRATO)) NOMBRE,
       NVL((SELECT T.DESCDIRECC
             FROM ARQU.CADIRECCION T
            WHERE T.IDPREDIO =
                  ARQU.PKG_MDCACONTRATO.FNUGETIDPREDIO(CAPROD.IDCONTRATO)),
           ARQU.PKG_MDCARESPOSERVI.FVAGETDIRCORRESP(ARQU.PKG_MDCACONTRATO.FNUGETIDRESPONSABLE(CAPROD.IDCONTRATO))) DIRECCION,
       ARQU.PKG_MDLECRUTA.FVAGETRUTA(CAPROD.IDRUTA) RUTA,
       CAPROD.IDCONTRATO CONTRATO,
       (SELECT COUNT(1)
          FROM ARQU.FACUENTA A
         WHERE A.IDPRODUCTO = CAPROD.IDPRODUCTO
           AND SALDOCUENTA > 0) CUENTAS_CON_SALDO,
       ARQU.PKG_MDCABARRIO.FVAGETDESCBARRIO(CADIRE.IDBARRIO) BARRIO,
       ARQU.PKG_MDCAUSO.FVAGETDESCUSO(CAPROD.IDUSO) USO,
       CAPROD.IDESTRATO || ' - ' ||
       ARQU.PKG_MDCAESTRATO.FVAGETDESESTRATO(CAPROD.IDUSO, CAPROD.IDESTRATO) ESTRATO,
       CAPROD.IDZONAOPER ZONA,
       (SELECT MAX(CA.DESCDIRECC)
          FROM ARQU.CADIRECCION CA
         WHERE CA.IDPREDIO = CAPRED.IDPREDIO) DIREC_PREDIO,
       ARQU.PKG_MDLECMARCEQUIMEDI.FVAGETNOMBRE(ARQU.PKG_MDLECEQUIPMEDIC.FNUGETIDMARCA(ARQU.PKG_MDMEPUNTOMEDI.FVAGETIDEQUIPO(CAPRODUC.IDPUNTOMEDI))) MARCA,
       ARQU.PKG_MDLECREFERMARCA.FVAGETNOMBRE(ARQU.PKG_MDLECEQUIPMEDIC.FNUGETIDMARCA(ARQU.PKG_MDMEPUNTOMEDI.FVAGETIDEQUIPO(CAPRODUC.IDPUNTOMEDI)),
                                             ARQU.PKG_MDLECEQUIPMEDIC.FNUGETIDREFEMARCA(ARQU.PKG_MDMEPUNTOMEDI.FVAGETIDEQUIPO(CAPRODUC.IDPUNTOMEDI))) REF_TIPO,
       ARQU.PKG_MDMEPUNTOMEDI.FDAGETFECHAREGISTRO(CAPRODUC.IDPUNTOMEDI) FECHA_REGISTRO_MEDIDOR
  FROM ARQU.CAPRODUCTOS  CAPROD,
       ARQU.CADIRECCION  CADIRE,
       ARQU.CAPRODUCMEDI CAPRODUC,
       ARQU.FAPERIODO    FAPER,
       ARQU.CAPREDIO     CAPRED,
       ARQU.CABARRIO     CABAR,
       ARQU.LECONSUMOS   LECONS
 WHERE CAPRODUC.ESTADO = 'S'
   AND ARQU.PKG_MDCACONTRATO.FNUGETIDPREDIO(CAPROD.IDCONTRATO) =
       CADIRE.IDPREDIO
   AND CAPROD.IDPRODUCTO = CAPRODUC.IDPRODUCTO
   AND CADIRE.IDPREDIO = CAPRED.IDPREDIO
   AND CAPRED.IDBARRIO = CABAR.IDBARRIO
   AND LECONS.IDPERIODO = FAPER.IDFAPERICONSU
   AND LECONS.IDPUNTOMEDI = CAPRODUC.IDPUNTOMEDI
   AND FAPER.PERIANO = := NUA
   AND FAPER.PERIMES = := NUB
   AND FAPER.IDCICLO = DECODE(:= NUC, -1, FAPER.IDCICLO, := NUC)
   AND CAPROD.IDSERVICIO = 1
